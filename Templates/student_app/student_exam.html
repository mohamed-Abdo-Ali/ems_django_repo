{% extends "base.html" %}
{% load static %}
{% load arabic_tags %}

{% block title %} الامتحان | EMS {% endblock title %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-2 md:gap-4 max-w-full mx-auto px-2 md:px-4 py-2 h-screen">

  <!-- المحتوى الرئيسي -->
  <div class="flex-1">
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-4">
      <!-- رأس الصفحة -->
      <div class="bg-blue-600 text-white p-2 md:p-2">
        <div class="flex flex-row items-stretch justify-between gap-1 md:gap-4">
          <!-- يمين -->
          <div class="text-center min-w-[100px] md:w-1/4 px-1 font-tajawal flex flex-col justify-center">
            <p class="text-xs md:text-base font-semibold mb-1 truncate">الجمهورية اليمنية</p>
            <p class="text-xs md:text-base mb-1 truncate">وزارة التربية و التعليم</p>
            <p class="text-xs md:text-base mb-1 truncate">جامعة تعز فرع التربة</p>
            <p class="text-xs md:text-base truncate">كلية الحاسبات و تقنية المعلومات</p>
          </div>

          <!-- وسط -->
          <div class="flex flex-col items-center min-w-[80px] md:w-1/4 px-1 self-center">
            <img src="{% static 'img/tize_unvercity_logo.svg' %}" alt="شعار الجامعة" class="h-12 md:h-20 w-12 md:w-20 object-contain mb-1" />
            <p class="text-xs md:text-base mb-1">{% now "Y" %}</p>
            <p class="text-xs md:text-base">أجب مستعيناً بالله</p>
          </div>

          <!-- يسار -->
          <div class="text-center min-w-[100px] md:w-1/4 px-1 font-tajawal flex flex-col justify-center">
            <p class="text-xs md:text-sm font-semibold mb-1 truncate">التخصص: {{ exam.course.major.name }}</p>
            <p class="text-xs md:text-base mb-1 truncate">المقرر: {{ exam.course.name }}</p>
            <p class="text-xs md:text-base mb-1 truncate">الزمن: {{ exam.duration }} ساعات</p>
            <p class="text-xs md:text-base mb-1 truncate">
              {% if exam.exam_type == 1 %}
                اختبار نصف الترم
              {% elif exam.exam_type == 2 %}
                امتحان نهاية الترم
              {% elif exam.exam_type == 3 %}
                امتحان تجريبي
              {% endif %}
            </p>
            <div class="timer text-sm md:text-xl font-bold bg-blue-800 px-2 md:px-4 py-1 md:py-2 rounded-lg inline-block">
              <span id="time">--:--:--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- معلومات الطالب -->
      <div class="border-b border-gray-200 p-2 md:p-4 bg-gray-50 flex flex-row items-center gap-4">
        <p class="text-gray-700 text-xs md:text-base">
          <span class="font-semibold"></span> {{ connected_user.full_name }}
        </p>
        <p class="text-gray-700 text-xs md:text-base">
          <span class="font-semibold"></span> {{ the_student.university_id }}
        </p>

        {% comment %} //دالة عرض مربع الةقت المنتقضي و عددالاسئلة  {% endcomment %}
        {% comment %} <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md text-right">
          <div class="flex flex-col gap-1">
            <div>بدأ الامتحان: <span class="font-semibold">{{ start_time|date:"Y-m-d H:i:s" }}</span></div>
            {% if is_submitted and end_time %}
              <div>انتهى الامتحان: <span class="font-semibold">{{ end_time|date:"Y-m-d H:i:s" }}</span></div>
            {% endif %}
            <div>الوقت المنقضي: <span id="elapsed" class="font-semibold">00:00</span></div>
            <div>التقدّم: <span class="font-semibold">{{ answered_count }} / {{ total_questions }}</span> سؤال</div>
          </div>
        </div> {% endcomment %}

      </div>

      <!-- شريط التقدم أعلى الصفحة -->
      <div class="bg-gray-200 h-2">
        <div id="progress-bar" class="h-2 bg-blue-500 transition-all duration-500" style="width: 0%"></div>
      </div>

      <!-- أسئلة الامتحان -->
      <div class="p-2">
        <form id="exam-form" method="POST">
          {% csrf_token %}

          {% for item in items %}
            {% with question=item.q %}
            <div
              class="question-container {% if forloop.first %}block{% else %}hidden{% endif %}"
              id="question-{{ forloop.counter }}"
              data-question="{{ forloop.counter }}"
              data-question-id="{{ question.id }}"
              data-qtype="{{ item.type }}"
            >
              <div class="mb-3 p-3 md:p-4 border border-gray-200 rounded-lg transition-all duration-300 hover:shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-start mb-2 gap-1">
                  <h3 class="text-sm md:text-lg font-semibold text-gray-800">
                    السؤال: {{ forloop.counter }}
                  </h3>
                  <span class="bg-blue-100 text-blue-800 text-xs md:text-sm font-medium px-2 py-1 rounded-full">
                    درجة السؤال: {{ item.points }}
                  </span>
                </div>

                <p class="text-gray-700 text-xs md:text-base mb-2 md:mb-3">
                  {{ item.text }}
                </p>

                {% if item.type == 3 or item.type == 1 %}
                <!-- Multiple Choice (3) أو True/False (1) -->
                <div class="space-y-1 md:space-y-2">
                  {% for ans in item.answers %}
                  <div class="transition-all duration-200 hover:-translate-x-1">
                    <input
                      type="radio"
                      name="question_{{ question.id }}"
                      id="q{{ question.id }}_opt{{ ans.id }}"
                      value="{{ ans.id }}"
                      class="hidden peer"
                      {% if item.saved_choice_id and item.saved_choice_id == ans.id %}checked{% endif %}
                      {% if is_submitted %}disabled{% endif %}
                    />
                    <label
                      for="q{{ question.id }}_opt{{ ans.id }}"
                      class="block w-full p-2 md:p-3 border border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-gray-50 text-xs md:text-base text-gray-800"
                    >
                      <span class="font-medium">{{ ans.answer_text }}</span>
                    </label>
                  </div>
                  {% endfor %}
                </div>

                {% elif item.type == 2 %}
                <!-- عددي -->
                <div class="numeric-question mt-3">
                  <input
                    type="number"
                    name="numeric_answer_{{ question.id }}"
                    id="numeric_{{ question.id }}"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800"
                    placeholder="أدخل الإجابة الرقمية هنا"
                    step="any"
                    value="{{ item.saved_numeric }}"
                    {% if is_submitted %}disabled{% endif %}
                  />
                  {% if not is_submitted %}
                  <button
                    type="button"
                    class="mt-2 bg-blue-600 text-white px-4 py-2 rounded save-answer-btn"
                    data-question-id="{{ question.id }}"
                    data-type="numeric"
                  >حفظ</button>
                  {% endif %}
                  <div id="snackbar-{{ forloop.counter }}" class="hidden mt-2 text-green-600 text-sm">✅ تم الحفظ بنجاح</div>
                </div>

                {% elif item.type == 4 %}
                <!-- مقالي -->
                <div class="essay-question mt-3">
                  <textarea
                    name="essay_answer_{{ question.id }}"
                    id="essay_{{ question.id }}"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800"
                    rows="5"
                    placeholder="أكتب إجابتك هنا..."
                    {% if is_submitted %}disabled{% endif %}
                  >{{ item.saved_essay }}</textarea>
                  {% if not is_submitted %}
                  <button
                    type="button"
                    class="mt-2 bg-blue-600 text-white px-4 py-2 rounded save-answer-btn"
                    data-question-id="{{ question.id }}"
                    data-type="essay"
                  >حفظ</button>
                  {% endif %}
                  <div id="snackbar-{{ forloop.counter }}" class="hidden mt-2 text-green-600 text-sm">✅ تم الحفظ بنجاح</div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endwith %}
          {% endfor %}

          <!-- مودال التأكيد -->
          <div id="confirm-modal" class="fixed inset-0 z-50 hidden">
            <div id="confirm-backdrop" class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm opacity-0 transition-opacity duration-200"></div>
            <div class="absolute inset-0 flex items-center justify-center p-4">
              <div id="confirm-panel" class="w-full max-w-md rounded-2xl bg-white shadow-2xl ring-1 ring-black/5 opacity-0 scale-95 transition duration-200">
                <div class="p-5 border-b">
                  <h3 class="text-lg font-semibold text-gray-900">تأكيد إنهاء الامتحان</h3>
                  <p class="mt-1 text-sm text-gray-600">أنت على وشك إنهاء الامتحان. بعد الإنهاء لن تتمكن من تعديل إجاباتك.</p>
                </div>
                <div class="p-5 space-y-3 text-sm text-gray-700">
                  <div class="flex items-center gap-2"><span class="inline-flex h-2 w-2 rounded-full bg-red-500"></span>تأكد أنك أجبت على جميع الأسئلة المطلوبة.</div>
                  <div class="flex items-center gap-2"><span class="inline-flex h-2 w-2 rounded-full bg-blue-500"></span>سيتم إرسال إجاباتك فورًا إلى النظام.</div>
                </div>
                <div class="p-4 bg-gray-50 flex items-center justify-between gap-3 rounded-b-2xl">
                  <button id="cancel-submit" type="button" class="px-4 py-2 rounded-xl bg-white text-gray-700 border border-gray-300 hover:bg-gray-100 transition">تراجع</button>
                  <button id="confirm-submit" type="button" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 shadow-sm transition">نعم، إنهاء الامتحان</button>
                </div>
              </div>
            </div>
          </div>

          <!-- الأزرار -->
          <div class="flex justify-between mt-3 md:mt-4 gap-1">
            <button
              type="button"
              id="prev-btn"
              class="px-2 py-1 md:px-4 md:py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-xs md:text-base"
              disabled
            >
              السابق
            </button>

            <button
              type="button"
              id="next-btn"
              class="px-2 py-1 md:px-4 md:py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-all text-xs md:text-base"
            >
              التالي
            </button>

            {% if not is_submitted %}
            <button
              type="submit"
              id="submit-btn"
              name="finsh_submet_exam_butt"
              value="1"
              class="px-2 py-1 md:px-4 md:py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-all text-xs md:text-base hidden"
            >
              إنهاء الامتحان
            </button>
            {% else %}
            <span class="px-3 py-2 text-green-700 font-semibold">تم تسليم الامتحان</span>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- القائمة الجانبية -->
  <div class="lg:w-48 xl:w-56 h-full">
    <div class="sticky top-0 h-full">
      <div class="bg-gradient-to-br from-red-50 to-red-100 p-2 rounded-lg border border-red-200 shadow-sm h-full flex flex-col">
        <h3 class="text-sm md:text-base font-semibold mb-2 text-center text-red-800">قائمة الأسئلة</h3>
        <div class="flex-1 overflow-y-auto pr-1 custom-scroll">
          {% for item in items %}
          <div
            class="relative flex items-center gap-2 p-1 hover:bg-red-100 rounded transition-all cursor-pointer"
            onclick="goToQuestion({{ forloop.counter }})"
          >
            <!-- شريط الإنجاز -->
            <div class="absolute inset-y-0 right-0 w-0 bg-gradient-to-r from-green-300 to-green-500 transition-all duration-2000 ease-out" id="progress-{{ forloop.counter }}"></div>

            <!-- رقم السؤال -->
            <div
              class="relative z-10 w-6 h-6 md:w-8 md:h-8 flex-shrink-0 flex items-center justify-center rounded-md cursor-pointer transition-all duration-200 text-xs md:text-sm
              {% if forloop.first %}border-2 border-blue-500 bg-white text-blue-500{% else %}bg-red-500 text-white{% endif %}"
              data-question="{{ forloop.counter }}"
              data-question-id="{{ item.q.id }}"
              id="dot-{{ forloop.counter }}"
            >
              {{ forloop.counter }}
            </div>

            <!-- نص مختصر -->
            <div class="relative z-10 flex-1 min-w-0 overflow-hidden">
              <p class="text-xs md:text-sm text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis" title="{{ item.text }}">
                {{ item.text }}
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- أنماط إضافية -->
  <style>
    .font-tajawal { font-family: 'Tajawal', sans-serif; }

    body { color: #1f2937; }
    textarea, input[type="number"], input[type="text"] { color: #1f2937 !important; }
    textarea:focus, input:focus { color: #1f2937; }

    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: #fecaca; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 4px; }

    [id^="progress-"] { opacity: 0.6; z-index: 1; }

    .transition-all {
      transition-property: all;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 200ms;
    }

    /* لإخفاء الأسهم في Chrome, Safari, Edge */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* لإخفاء الأسهم في Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }
  </style>
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
  .font-tajawal { font-family: 'Tajawal', sans-serif; }
</style>
{% endblock content %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // إعدادات عامة
    let examDurationHours = {{ exam.duration }};
    let timeLeft = examDurationHours * 60 * 60;

    const timerElement = document.getElementById('time');
    const progressBar = document.getElementById('progress-bar');
    const form = document.getElementById('exam-form');

    const totalQuestions = {{ items|length }};
    let currentQuestion = 1;

    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const submitBtn = document.getElementById('submit-btn');

    // مودال التأكيد
    const modal = document.getElementById('confirm-modal');
    const backdrop = document.getElementById('confirm-backdrop');
    const panel = document.getElementById('confirm-panel');
    const confirmBtn = document.getElementById('confirm-submit');
    const cancelBtn = document.getElementById('cancel-submit');

    let isSubmitting = false;
    let lastSubmitter = null;



    //دالة عرض مربع الةقت المنتقضي و عددالاسئلة 
    {% comment %} (function () {
      var elapsed = {{ elapsed_seconds|default:0 }};
      var el = document.getElementById('elapsed');
      function fmt(t) {
        var h = Math.floor(t / 3600);
        var m = Math.floor((t % 3600) / 60);
        var s = t % 60;
        if (h) return h + ":" + String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
        return m + ":" + String(s).padStart(2,'0');
      }
      function render() { el.textContent = fmt(elapsed); }
      render();
      {% if not is_submitted %}
        setInterval(function(){ elapsed += 1; render(); }, 1000);
      {% endif %}
    })(); {% endcomment %}

    // المؤقت
    function updateTimer() {
      const hours = Math.floor(timeLeft / 3600);
      const minutes = Math.floor((timeLeft % 3600) / 60);
      const seconds = timeLeft % 60;

      timerElement.textContent =
        `${hours.toString().padStart(2, '0')}:` +
        `${minutes.toString().padStart(2, '0')}:` +
        `${seconds.toString().padStart(2, '0')}`;

      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        const timeUp = document.createElement('input');
        timeUp.type = 'hidden';
        timeUp.name = 'time_up';
        timeUp.value = '1';
        form.appendChild(timeUp);

        const finishFlag = document.createElement('input');
        finishFlag.type = 'hidden';
        finishFlag.name = 'finsh_submet_exam_butt';
        finishFlag.value = '1';
        form.appendChild(finishFlag);

        form.submit();
        return;
      } else {
        timeLeft--;
      }

      const progressPercent = (currentQuestion / totalQuestions) * 100;
      progressBar.style.width = `${progressPercent}%`;
    }
    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    // تنقل بين الأسئلة
    function toggleNavButtons() {
      prevBtn.disabled = (currentQuestion === 1);
      if (currentQuestion === totalQuestions) {
        nextBtn.classList.add('hidden');
        if (submitBtn) submitBtn.classList.remove('hidden');
      } else {
        nextBtn.classList.remove('hidden');
        if (submitBtn) submitBtn.classList.add('hidden');
      }
      const progressPercent = (currentQuestion / totalQuestions) * 100;
      progressBar.style.width = `${progressPercent}%`;
    }

    // التحقق من إجابة سؤال معيّن
    function isAnswered(questionNum) {
      const container = document.getElementById(`question-${questionNum}`);
      if (!container) return false;

      // اختياري (راديو)
      if (container.querySelector('input[type="radio"]:checked')) return true;

      // مقالي
      const essay = container.querySelector('textarea[name^="essay_answer_"]');
      if (essay && essay.value.trim().length > 0) return true;

      // عددي
      const numeric = container.querySelector('input[type="number"][name^="numeric_answer_"]');
      if (numeric) {
        const v = (numeric.value ?? '').toString().trim();
        if (v !== '' && !isNaN(parseFloat(v))) return true;
      }

      return false;
    }

    // تحديث حالة نقطة السؤال في الشريط الجانبي
    function updateSidebarStatus(questionNum) {
      const dot = document.getElementById(`dot-${questionNum}`);
      const progress = document.getElementById(`progress-${questionNum}`);
      if (!dot) return;

      const activeClasses = ['border-2', 'border-blue-500', 'bg-white', 'text-blue-500'];
      const redClasses = ['bg-red-500', 'text-white'];
      const greenClasses = ['bg-green-500', 'text-white'];

      const answered = isAnswered(questionNum);

      // تنظيف الألوان السابقة
      dot.classList.remove(...activeClasses, ...redClasses, ...greenClasses);

      if (questionNum === currentQuestion) {
        dot.classList.add(...activeClasses);
      } else if (answered) {
        dot.classList.add(...greenClasses);
      } else {
        dot.classList.add(...redClasses);
      }

      if (progress) {
        progress.style.width = answered ? '100%' : '0%';
        progress.style.transition = 'width 0.7s cubic-bezier(0.65, 0, 0.35, 1)';
      }
    }

    // تحديث جميع النقاط
    function refreshAllSidebar() {
      for (let i = 1; i <= totalQuestions; i++) {
        updateSidebarStatus(i);
      }
    }

    // الانتقال لسؤال محدد
    window.goToQuestion = function (questionNum) {
      document.querySelectorAll('.question-container').forEach(q => {
        q.classList.add('hidden');
        q.classList.remove('block');
      });
      const target = document.getElementById(`question-${questionNum}`);
      if (target) {
        target.classList.remove('hidden');
        target.classList.add('block');
      }
      currentQuestion = questionNum;
      toggleNavButtons();
      refreshAllSidebar();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    nextBtn.addEventListener('click', function () {
      if (currentQuestion < totalQuestions) goToQuestion(currentQuestion + 1);
    });
    prevBtn.addEventListener('click', function () {
      if (currentQuestion > 1) goToQuestion(currentQuestion - 1);
    });

    // مودال التأكيد
    function openModal() {
      modal.classList.remove('hidden');
      requestAnimationFrame(() => {
        backdrop.classList.remove('opacity-0');
        panel.classList.remove('opacity-0', 'scale-95');
      });
      confirmBtn.focus();
    }
    function closeModal() {
      backdrop.classList.add('opacity-0');
      panel.classList.add('opacity-0', 'scale-95');
      setTimeout(() => modal.classList.add('hidden'), 180);
    }

    form.addEventListener('submit', function (e) {
      if (isSubmitting) return;
      lastSubmitter = e.submitter || null;
      if (typeof timeLeft !== 'undefined' && timeLeft > 0) {
        e.preventDefault();
        openModal();
      }
    });

    confirmBtn.addEventListener('click', function () {
      isSubmitting = true;
      closeModal();
      if (form.requestSubmit && lastSubmitter) {
        form.requestSubmit(lastSubmitter);
      } else if (lastSubmitter) {
        lastSubmitter.click();
      } else {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'finsh_submet_exam_butt';
        hidden.value = '1';
        form.appendChild(hidden);
        form.submit();
      }
    });

    cancelBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);
    document.addEventListener('keydown', function (e) {
      if (!modal.classList.contains('hidden') && e.key === 'Escape') closeModal();
    });

    // حفظ الإجابات (AJAX) - موحد
    function saveAnswer(questionType, container) {
      const el = container || document.querySelector('.question-container:not(.hidden)');
      if (!el) return;
      const questionId = el.getAttribute('data-question-id');
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', csrfToken);
      formData.append('question_id', questionId);

      if (questionType === 'objective') {
        const selected = el.querySelector('input[type="radio"]:checked');
        if (!selected) return;
        formData.append('answer_id', selected.value);
      } else if (questionType === 'numeric') {
        const input = el.querySelector('input[type="number"]');
        if (!input || input.value === '') return;
        formData.append('answer_value', input.value);
      } else if (questionType === 'essay') {
        const ta = el.querySelector('textarea');
        if (!ta) return;
        formData.append('answer_text', ta.value || '');
      } else {
        return;
      }

      return fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      }).then(r => {
        if (!r.ok) throw new Error('Network error');
        return true;
      });
    }

    // رسالة نجاح/فشل داخل حاوية السؤال فقط
    function showSnackbar(container, isError = false) {
      const el = container.querySelector('[id^="snackbar-"]');
      if (!el) return;
      el.textContent = isError ? '❌ حدث خطأ أثناء الحفظ' : '✅ تم الحفظ بنجاح';
      el.classList.remove('hidden');
      el.classList.toggle('text-green-600', !isError);
      el.classList.toggle('text-red-600', isError);
      setTimeout(() => {
        el.classList.add('hidden');
      }, 1500);
    }

    // تفعيل الراديو (موضوعي)
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const container = radio.closest('.question-container');
        const qNum = Number(container?.getAttribute('data-question')) || 1;
        const p = saveAnswer('objective', container);
        if (p && typeof p.then === 'function') {
          p.finally(() => updateSidebarStatus(qNum));
        } else {
          updateSidebarStatus(qNum);
        }
      });
    });

    // حفظ عددي/مقالي
    document.querySelectorAll('.save-answer-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const container = btn.closest('.question-container');
        const type = btn.getAttribute('data-type'); // essay | numeric
        const qNum = Number(container?.getAttribute('data-question')) || 1;

        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '... جاري الحفظ';

        const promise = saveAnswer(type, container);
        if (!promise) {
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        promise
          .then(() => {
            showSnackbar(container, false);
            updateSidebarStatus(qNum);
          })
          .catch(() => {
            showSnackbar(container, true);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = originalText;
          });
      });
    });

    // تهيئة أولية
    toggleNavButtons();
    refreshAllSidebar();
  });
</script>
{% endblock extra_js %}






























































{% comment %} ============================================================================================================================ {% endcomment %}
{% comment %} ============================================================================================================================ {% endcomment %}
{% comment %} {% extends "base.html" %}
{% load static %}
{% load arabic_tags %}

{% block title %} الامتحان | EMS {% endblock title %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-2 md:gap-4 max-w-full mx-auto px-2 md:px-4 py-2 h-screen">

  <!-- المحتوى الرئيسي -->
  <div class="flex-1">
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-4">
      <!-- رأس الصفحة -->
      <div class="bg-blue-600 text-white p-2 md:p-2">
        <div class="flex flex-row items-stretch justify-between gap-1 md:gap-4">
          <!-- يمين -->
          <div class="text-center min-w-[100px] md:w-1/4 px-1 font-tajawal flex flex-col justify-center">
            <p class="text-xs md:text-base font-semibold mb-1 truncate">الجمهورية اليمنية</p>
            <p class="text-xs md:text-base mb-1 truncate">وزارة التربية و التعليم</p>
            <p class="text-xs md:text-base mb-1 truncate">جامعة تعز فرع التربة</p>
            <p class="text-xs md:text-base truncate">كلية الحاسبات و تقنية المعلومات</p>
          </div>

          <!-- وسط -->
          <div class="flex flex-col items-center min-w-[80px] md:w-1/4 px-1 self-center">
            <img src="{% static 'img/tize_unvercity_logo.svg' %}" alt="شعار الجامعة" class="h-12 md:h-20 w-12 md:w-20 object-contain mb-1" />
            <p class="text-xs md:text-base mb-1">{% now "Y" %}</p>
            <p class="text-xs md:text-base">أجب مستعيناً بالله</p>
          </div>

          <!-- يسار -->
          <div class="text-center min-w-[100px] md:w-1/4 px-1 font-tajawal flex flex-col justify-center">
            <p class="text-xs md:text-sm font-semibold mb-1 truncate">التخصص: {{ first_exam.course.major.name }}</p>
            <p class="text-xs md:text-base mb-1 truncate">المقرر: {{ first_exam.course.name }}</p>
            <p class="text-xs md:text-base mb-1 truncate">الزمن: {{ first_exam.duration }} ساعتان</p>
            <p class="text-xs md:text-base mb-1 truncate">
              {% if first_exam.exam_type == 1 %}
                اختبار نصف الترم
              {% elif first_exam.exam_type == 2 %}
                امتحان نهاية الترم
              {% elif first_exam.exam_type == 3 %}
                امتحان تجريبي
              {% endif %}
            </p>
            <div class="timer text-sm md:text-xl font-bold bg-blue-800 px-2 md:px-4 py-1 md:py-2 rounded-lg inline-block">
              <span id="time">01:59:00</span><br>
              <!-- <span>{{first_exam.duration}}</span> -->
            </div>
          </div>
        </div>
      </div>

      <!-- معلومات الطالب -->
      <div class="border-b border-gray-200 p-2 md:p-4 bg-gray-50 flex flex-row items-center gap-4">
        <p class="text-gray-700 text-xs md:text-base">
          <span class="font-semibold"></span> {{ connected_user.full_name }}
        </p>
        <p class="text-gray-700 text-xs md:text-base">
          <span class="font-semibold"></span> {{ the_student.university_id }}
        </p>
      </div>

      <!-- شريط التقدم أعلى الصفحة -->
      <div class="bg-gray-200 h-2">
        <div id="progress-bar" class="h-2 bg-blue-500 transition-all duration-500" style="width: 0%"></div>
      </div>

      <!-- أسئلة الامتحان -->
      <div class="p-2">
        <form id="exam-form" method="POST">
          {% csrf_token %}

          {% for question in exam_question_all_qution %}
          <div
            class="question-container {% if forloop.first %}block{% else %}hidden{% endif %}"
            id="question-{{ forloop.counter }}"
            data-question="{{ forloop.counter }}"
            data-question-id="{% if question|is_question %}{{ question.id }}{% elif question|is_essay_question %}{{ question.id }}{% elif question|is_numeric_question %}{{ question.id }}{% endif %}"
          >
            <div class="mb-3 p-3 md:p-4 border border-gray-200 rounded-lg transition-all duration-300 hover:shadow-lg">
              <div class="flex flex-col md:flex-row justify-between items-start mb-2 gap-1">
                <h3 class="text-sm md:text-lg font-semibold text-gray-800">
                  السؤال: {{ forloop.counter|arabic_ordinal }}
                </h3>
                <span class="bg-blue-100 text-blue-800 text-xs md:text-sm font-medium px-2 py-1 rounded-full">
                  درجة السؤال:
                  {% if question|is_question %}
                    {{ question.points }}
                  {% elif question|is_essay_question %}
                    {{ question.marks }}
                  {% elif question|is_numeric_question %}
                    {{ question.marks }}
                  {% endif %}
                </span>
              </div>

              <!-- نص السؤال -->
              <p class="text-gray-700 text-xs md:text-base mb-2 md:mb-3">
                {% if question|is_question %}
                  {{ question.text }}
                {% elif question|is_essay_question %}
                  {{ question.question_text }}
                {% elif question|is_numeric_question %}
                  {{ question.question_text }}
                {% endif %}
              </p>

              {% if question|is_question %}
              <!-- اختيارات -->
              <div class="space-y-1 md:space-y-2">
                {% for answer in question.answers.all %}
                <div class="transition-all duration-200 hover:-translate-x-1">
                  <input
                    type="radio"
                    
                    name="question_{{ question.id }}"
                    id="q{{ question.id }}_option{{ forloop.counter }}"
                    value="{{ answer.id }}"
                    class="hidden peer"
                    
                  />
                  <label
                    for="q{{ question.id }}_option{{ forloop.counter }}"
                    class="block w-full p-2 md:p-3 border border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-gray-50 text-xs md:text-base text-gray-800"
                  >
                    <span class="font-medium">{{ answer.answer_text }}</span>
                  </label>
                </div>
                {% endfor %}
              </div>

              {% elif question|is_essay_question %}
              <!-- مقالي -->
              <div class="essay-question mt-3">
                <textarea
                  name="essay_answer_{{ question.id }}"
                  id="essay_{{ question.id }}"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800"
                  rows="5"
                  placeholder="أكتب إجابتك هنا..."
                ></textarea>
                <div class="mt-2 text-xs text-gray-500">
                  <p>ملاحظة: تأكد من مراجعة إجابتك قبل التسليم.</p>
                </div>

                <!-- زر الحفظ + رسالة النجاح -->
                <button
                  type="button"
                  class="mt-2 bg-blue-600 text-white px-4 py-2 rounded save-answer-btn"
                  data-question-id="{{ question.id }}"
                  data-type="essay"
                >
                  حفظ
                </button>
                <div id="snackbar-{{ forloop.counter }}" class="hidden mt-2 text-green-600 text-sm">
                  ✅ تم الحفظ بنجاح
                </div>
              </div>

              {% elif question|is_numeric_question %}
              <!-- عددي -->
              <div class="numeric-question mt-3">
                <input
                  type="number"
                  name="numeric_answer_{{ question.id }}"
                  id="numeric_{{ question.id }}"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800"
                  placeholder="أدخل الإجابة الرقمية هنا"
                  step="any"
                  oninput="this.value = this.value.replace(/[^0-9.]/g,'')"
                  pattern="[0-9]*"
                />
                <div class="mt-2 text-xs text-gray-500">
                  <p>ملاحظة: أدخل الرقم فقط دون أي رموز أو أحرف أخرى.</p>
                </div>

                <!-- زر الحفظ + رسالة النجاح -->
                <button
                  type="button"
                  class="mt-2 bg-blue-600 text-white px-4 py-2 rounded save-answer-btn"
                  data-question-id="{{ question.id }}"
                  data-type="numeric"
                >
                  حفظ
                </button>
                <div id="snackbar-{{ forloop.counter }}" class="hidden mt-2 text-green-600 text-sm">
                  ✅ تم الحفظ بنجاح
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}

          <!-- مودال التأكيد -->
          <div id="confirm-modal" class="fixed inset-0 z-50 hidden">
            <div id="confirm-backdrop" class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm opacity-0 transition-opacity duration-200"></div>
            <div class="absolute inset-0 flex items-center justify-center p-4">
              <div id="confirm-panel" class="w-full max-w-md rounded-2xl bg-white shadow-2xl ring-1 ring-black/5 opacity-0 scale-95 transition duration-200">
                <div class="p-5 border-b">
                  <h3 class="text-lg font-semibold text-gray-900">تأكيد إنهاء الامتحان</h3>
                  <p class="mt-1 text-sm text-gray-600">أنت على وشك إنهاء الامتحان. بعد الإنهاء لن تتمكن من تعديل إجاباتك.</p>
                </div>
                <div class="p-5 space-y-3 text-sm text-gray-700">
                  <div class="flex items-center gap-2"><span class="inline-flex h-2 w-2 rounded-full bg-red-500"></span>تأكد أنك أجبت على جميع الأسئلة المطلوبة.</div>
                  <div class="flex items-center gap-2"><span class="inline-flex h-2 w-2 rounded-full bg-blue-500"></span>سيتم إرسال إجاباتك فورًا إلى النظام.</div>
                </div>
                <div class="p-4 bg-gray-50 flex items-center justify-between gap-3 rounded-b-2xl">
                  <button id="cancel-submit" type="button" class="px-4 py-2 rounded-xl bg-white text-gray-700 border border-gray-300 hover:bg-gray-100 transition">تراجع</button>
                  <button id="confirm-submit" type="button" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 shadow-sm transition">نعم، إنهاء الامتحان</button>
                </div>
              </div>
            </div>
          </div>

          <!-- الأزرار -->
          <div class="flex justify-between mt-3 md:mt-4 gap-1">
            <button
              type="button"
              id="prev-btn"
              class="px-2 py-1 md:px-4 md:py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-xs md:text-base"
              disabled
            >
              السابق
            </button>

            <button
              type="button"
              id="next-btn"
              class="px-2 py-1 md:px-4 md:py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-all text-xs md:text-base"
            >
              التالي
            </button>

            <!-- زر الإنهاء الموحد -->
            <button
              type="submit"
              id="submit-btn"
              name="finsh_submet_exam_butt"
              value="1"
              class="px-2 py-1 md:px-4 md:py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-all text-xs md:text-base hidden"
            >
              إنهاء الامتحان
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- القائمة الجانبية -->
  <div class="lg:w-48 xl:w-56 h-full">
    <div class="sticky top-0 h-full">
      <div class="bg-gradient-to-br from-red-50 to-red-100 p-2 rounded-lg border border-red-200 shadow-sm h-full flex flex-col">
        <h3 class="text-sm md:text-base font-semibold mb-2 text-center text-red-800">قائمة الأسئلة</h3>
        <div class="flex-1 overflow-y-auto pr-1 custom-scroll">
          {% for question in exam_question_all_qution %}
          <div
            class="relative flex items-center gap-2 p-1 hover:bg-red-100 rounded transition-all cursor-pointer"
            onclick="goToQuestion({{ forloop.counter }})"
          >
            <!-- شريط الإنجاز -->
            <div class="absolute inset-y-0 right-0 w-0 bg-gradient-to-r from-green-300 to-green-500 transition-all duration-2000 ease-out" id="progress-{{ forloop.counter }}"></div>

            <!-- رقم السؤال -->
            <div
              class="relative z-10 w-6 h-6 md:w-8 md:h-8 flex-shrink-0 flex items-center justify-center rounded-md cursor-pointer transition-all duration-200 text-xs md:text-sm
              {% if forloop.first %}border-2 border-blue-500 bg-white text-blue-500{% else %}bg-red-500 text-white{% endif %}"
              data-question="{{ forloop.counter }}"
              data-question-id="{% if question|is_question %}{{ question.id }}{% elif question|is_essay_question %}{{ question.id }}{% elif question|is_numeric_question %}{{ question.id }}{% endif %}"
              id="dot-{{ forloop.counter }}"
            >
              {{ forloop.counter }}
            </div>

            <!-- نص مختصر -->
            <div class="relative z-10 flex-1 min-w-0 overflow-hidden">
              <p
                class="text-xs md:text-sm text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis"
                title="{% if question|is_question %}{{ question.text }}{% elif question|is_essay_question %}{{ question.question_text }}{% elif question|is_numeric_question %}{{ question.question_text }}{% endif %}"
              >
                {% if question|is_question %}
                  {{ question.text }}
                {% elif question|is_essay_question %}
                  {{ question.question_text }}
                {% elif question|is_numeric_question %}
                  {{ question.question_text }}
                {% endif %}
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- أنماط إضافية -->
  <style>
    .font-tajawal { font-family: 'Tajawal', sans-serif; }

    body { color: #1f2937; }
    textarea, input[type="number"], input[type="text"] { color: #1f2937 !important; }
    textarea:focus, input:focus { color: #1f2937; }

    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: #fecaca; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #ef4444; border-radius: 4px; }

    [id^="progress-"] { opacity: 0.6; z-index: 1; }

    .transition-all {
      transition-property: all;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 200ms;
    }
    /* لإخفاء الأسهم في Chrome, Safari, Edge */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* لإخفاء الأسهم في Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }
  </style>
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
  .font-tajawal { font-family: 'Tajawal', sans-serif; }
</style>
{% endblock content %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // إعدادات عامة
    let examDurationHours = {{ first_exam.duration }};
    let timeLeft = examDurationHours * 60 * 60;

    const timerElement = document.getElementById('time');
    const progressBar = document.getElementById('progress-bar');
    const form = document.getElementById('exam-form');

    const totalQuestions = {{ exam_question_all_qution|length }};
    let currentQuestion = 1;

    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const submitBtn = document.getElementById('submit-btn');

    // مودال التأكيد
    const modal = document.getElementById('confirm-modal');
    const backdrop = document.getElementById('confirm-backdrop');
    const panel = document.getElementById('confirm-panel');
    const confirmBtn = document.getElementById('confirm-submit');
    const cancelBtn = document.getElementById('cancel-submit');

    let isSubmitting = false;
    let lastSubmitter = null;

    // المؤقت
    function updateTimer() {
      const hours = Math.floor(timeLeft / 3600);
      const minutes = Math.floor((timeLeft % 3600) / 60);
      const seconds = timeLeft % 60;

      timerElement.textContent =
        `${hours.toString().padStart(2, '0')}:` +
        `${minutes.toString().padStart(2, '0')}:` +
        `${seconds.toString().padStart(2, '0')}`;

      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        const timeUp = document.createElement('input');
        timeUp.type = 'hidden';
        timeUp.name = 'time_up';
        timeUp.value = '1';
        form.appendChild(timeUp);

        const finishFlag = document.createElement('input');
        finishFlag.type = 'hidden';
        finishFlag.name = 'finsh_submet_exam_butt';
        finishFlag.value = '1';
        form.appendChild(finishFlag);

        form.submit();
        return;
      } else {
        timeLeft--;
      }

      const progressPercent = (currentQuestion / totalQuestions) * 100;
      progressBar.style.width = `${progressPercent}%`;
    }
    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    // تنقل بين الأسئلة
    function toggleNavButtons() {
      prevBtn.disabled = (currentQuestion === 1);
      if (currentQuestion === totalQuestions) {
        nextBtn.classList.add('hidden');
        submitBtn.classList.remove('hidden');
      } else {
        nextBtn.classList.remove('hidden');
        submitBtn.classList.add('hidden');
      }
      const progressPercent = (currentQuestion / totalQuestions) * 100;
      progressBar.style.width = `${progressPercent}%`;
    }

    // التحقق من إجابة سؤال معيّن (ضمن حاوية السؤال فقط)
    function isAnswered(questionNum) {
      const container = document.getElementById(`question-${questionNum}`);
      if (!container) return false;

      // اختياري
      if (container.querySelector('input[type="radio"]:checked')) return true;

      // مقالي
      const essay = container.querySelector('textarea[name^="essay_answer_"]');
      if (essay && essay.value.trim().length > 0) return true;

      // عددي
      const numeric = container.querySelector('input[type="number"][name^="numeric_answer_"]');
      if (numeric) {
        const v = (numeric.value ?? '').toString().trim();
        if (v !== '' && !isNaN(parseFloat(v))) return true;
      }

      return false;
    }

    // تحديث حالة نقطة السؤال في الشريط الجانبي
    function updateSidebarStatus(questionNum) {
      const dot = document.getElementById(`dot-${questionNum}`);
      const progress = document.getElementById(`progress-${questionNum}`);
      if (!dot) return;

      const activeClasses = ['border-2', 'border-blue-500', 'bg-white', 'text-blue-500'];
      const redClasses = ['bg-red-500', 'text-white'];
      const greenClasses = ['bg-green-500', 'text-white'];

      const answered = isAnswered(questionNum);

      // تنظيف الألوان السابقة
      dot.classList.remove(...activeClasses, ...redClasses, ...greenClasses);

      if (questionNum === currentQuestion) {
        dot.classList.add(...activeClasses);
      } else if (answered) {
        dot.classList.add(...greenClasses);
      } else {
        dot.classList.add(...redClasses);
      }

      if (progress) {
        progress.style.width = answered ? '100%' : '0%';
        progress.style.transition = 'width 0.7s cubic-bezier(0.65, 0, 0.35, 1)';
      }
    }

    // تحديث جميع النقاط (للاستخدام عند التحميل أو الانتقال فقط)
    function refreshAllSidebar() {
      for (let i = 1; i <= totalQuestions; i++) {
        updateSidebarStatus(i);
      }
    }

    // الانتقال لسؤال محدد
    window.goToQuestion = function (questionNum) {
      document.querySelectorAll('.question-container').forEach(q => {
        q.classList.add('hidden');
        q.classList.remove('block');
      });
      const target = document.getElementById(`question-${questionNum}`);
      if (target) {
        target.classList.remove('hidden');
        target.classList.add('block');
      }
      currentQuestion = questionNum;
      toggleNavButtons();
      refreshAllSidebar();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    nextBtn.addEventListener('click', function () {
      if (currentQuestion < totalQuestions) goToQuestion(currentQuestion + 1);
    });
    prevBtn.addEventListener('click', function () {
      if (currentQuestion > 1) goToQuestion(currentQuestion - 1);
    });

    // مودال التأكيد
    function openModal() {
      modal.classList.remove('hidden');
      requestAnimationFrame(() => {
        backdrop.classList.remove('opacity-0');
        panel.classList.remove('opacity-0', 'scale-95');
      });
      confirmBtn.focus();
    }
    function closeModal() {
      backdrop.classList.add('opacity-0');
      panel.classList.add('opacity-0', 'scale-95');
      setTimeout(() => modal.classList.add('hidden'), 180);
    }

    form.addEventListener('submit', function (e) {
      if (isSubmitting) return;
      lastSubmitter = e.submitter || null;
      if (typeof timeLeft !== 'undefined' && timeLeft > 0) {
        e.preventDefault();
        openModal();
      }
    });

    confirmBtn.addEventListener('click', function () {
      isSubmitting = true;
      closeModal();
      if (form.requestSubmit && lastSubmitter) {
        form.requestSubmit(lastSubmitter);
      } else if (lastSubmitter) {
        lastSubmitter.click();
      } else {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'finsh_submet_exam_butt';
        hidden.value = '1';
        form.appendChild(hidden);
        form.submit();
      }
    });

    cancelBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);
    document.addEventListener('keydown', function (e) {
      if (!modal.classList.contains('hidden') && e.key === 'Escape') closeModal();
    });

    // حفظ الإجابات (AJAX)
    function saveAnswer(questionType, container) {
      const currentQuestionElement = container || document.querySelector('.question-container:not(.hidden)');
      if (!currentQuestionElement) return;

      const questionRealId = currentQuestionElement.getAttribute('data-question-id');
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      let formData = new FormData();

      if (questionType === 'objective') {
        const selectedOption = currentQuestionElement.querySelector('input[type="radio"]:checked');
        if (!selectedOption) return;
        formData.append('question_id', questionRealId);
        formData.append('answer_id', selectedOption.value);
        formData.append('question_type', 'objective');

      } else if (questionType === 'essay') {
        const answerText = currentQuestionElement.querySelector('textarea')?.value || '';
        if (!answerText.trim()) return;
        formData.append('question_id', questionRealId);
        formData.append('answer_text', answerText);
        formData.append('question_type', 'essay');

      } else if (questionType === 'numeric') {
        const numericInput = currentQuestionElement.querySelector('input[type="number"]');
        const answerValue = numericInput?.value;
        if (answerValue === undefined || answerValue === '' || isNaN(Number(answerValue))) return;
        formData.append('question_id', questionRealId);
        formData.append('answer_value', answerValue);
        formData.append('question_type', 'numeric');
      }

      formData.append('csrfmiddlewaretoken', csrfToken);

      return fetch('/student_app/student_exam/', {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return true;
      });
    }

    // رسالة نجاح/فشل داخل حاوية السؤال فقط
    function showSnackbar(container, isError = false) {
      const el = container.querySelector('[id^="snackbar-"]');
      if (!el) return;
      el.textContent = isError ? '❌ حدث خطأ أثناء الحفظ' : '✅ تم الحفظ بنجاح';
      el.classList.remove('hidden');
      el.classList.toggle('text-green-600', !isError);
      el.classList.toggle('text-red-600', isError);
      setTimeout(() => {
        el.classList.add('hidden');
      }, 1500);
    }

    // اختيارات (اختياري)
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const container = radio.closest('.question-container');
        const qNum = Number(container?.getAttribute('data-question')) || currentQuestion;
        const p = saveAnswer('objective', container);
        // حدّث نقطة السؤال الحالي فقط
        if (p && typeof p.then === 'function') {
          p.finally(() => updateSidebarStatus(qNum));
        } else {
          updateSidebarStatus(qNum);
        }
      });
    });

    // أزرار الحفظ (مقالي/عددي)
    document.querySelectorAll('.save-answer-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const container = btn.closest('.question-container');
        const type = btn.getAttribute('data-type'); // essay | numeric
        const qNum = Number(container?.getAttribute('data-question')) || currentQuestion;

        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '... جاري الحفظ';

        const promise = saveAnswer(type, container);
        if (!promise) {
          // لا يوجد إدخال صالح للحفظ
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        promise
          .then(() => {
            showSnackbar(container, false);
            updateSidebarStatus(qNum); // حدّث السؤال الحالي فقط
          })
          .catch(() => {
            showSnackbar(container, true);
          })
          .finally(() => {
            btn.disabled = false;
            btn.textContent = originalText;
          });
      });
    });

    // تهيئة أولية
    toggleNavButtons();
    refreshAllSidebar();
  });
</script>
{% endblock extra_js %} {% endcomment %}