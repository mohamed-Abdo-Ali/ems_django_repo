{% extends "base.html" %}

{% load static %} 
{% load arabic_tags %}
{% block title %} الامتحان | EMS  {% endblock title %}

{% block content %}

<div class="flex flex-col lg:flex-row gap-2 md:gap-4 max-w-full mx-auto px-2 md:px-4 py-2 h-screen">

  <!-- محتوى الامتحان الرئيسي -->
  <div class="flex-1">
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-4">
      <!-- رأس صفحة الامتحان -->
      <div class="bg-blue-600 text-white p-2 md:p-2">
        <div class="flex flex-row items-stretch justify-between gap-1 md:gap-4">
          <!-- البوكس الأيمن - نص -->
          <div class="text-center min-w-[100px] md:w-1/4 px-1 font-tajawal flex flex-col justify-center">
            <p class="text-xs md:text-base font-semibold mb-1 truncate">الجمهورية اليمنية</p>
            <p class="text-xs md:text-base mb-1 truncate">وزارة التربية و التعليم</p>
            <p class="text-xs md:text-base mb-1 truncate">جامعة تعز فرع التربة</p>
            <p class="text-xs md:text-base truncate">كلية الحاسبات و تقنية المعلومات</p>
          </div>

          <!-- البوكس الأوسط - صورة ونص -->
          <div class="flex flex-col items-center min-w-[80px] md:w-1/4 px-1 self-center">
            <img
              src="{% static 'img/tize_unvercity_logo.svg' %}"
              alt="شعار الجامعة"
              class="h-12 md:h-20 w-12 md:w-20 object-contain mb-1" 
            />
            <p class="text-xs md:text-base mb-1"> {% now "Y" %} </p>
            <p class="text-xs md:text-base">أجب مستعيناً بالله</p>
          </div>

          <!-- البوكس الأيسر - نص -->
          <div class="text-center min-w-[100px] md:w-1/4 px-1 font-tajawal flex flex-col justify-center">
            <p class="text-xs md:text-sm font-semibold mb-1 truncate">التخصص: {{first_exam.course.major.name}}</p>
            <p class="text-xs md:text-base mb-1 truncate">المقرر: {{first_exam.course.name}}</p>
            <p class="text-xs md:text-base mb-1 truncate">الزمن: {{first_exam.duration}} ساعتان</p>
            <p class="text-xs md:text-base mb-1 truncate">
              {% if first_exam.exam_type == 1 %}
                اختبار نصف الترم
              {% elif first_exam.exam_type == 2 %}
                امتحان نهاية الترم
              {% elif first_exam.exam_type == 3 %}
                امتحان تجريبي
              {% endif %}
            </p>
            <div class="timer text-sm md:text-xl font-bold bg-blue-800 px-2 md:px-4 py-1 md:py-2 rounded-lg inline-block">
              <span id="time">01:59:00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- معلومات الطالب -->
      <div class="border-b border-gray-200 p-2 md:p-4 bg-gray-50 flex flex-row items-center gap-4">
        <p class="text-gray-700 text-xs md:text-base">
          <span class="font-semibold"></span> {{ connected_user.full_name }}
        </p>
        <p class="text-gray-700 text-xs md:text-base">
          <span class="font-semibold"></span> {{ the_student.university_id }}
        </p>
      </div>

      <!-- شريط التقدم -->
      <div class="bg-gray-200 h-2">
        <div
          id="progress-bar"
          class="h-2 bg-blue-500 transition-all duration-500"
          style="width: 0%"
        ></div>
      </div>

      <!-- أسئلة الامتحان -->
      <div class="p-2">
        <form id="exam-form" method="POST">
          {% csrf_token %}
          
          {% for question in exam_question_all_qution %}
          {% comment %} <div class="question-container {% if forloop.first %}block{% else %}hidden{% endif %}" 
            id="question-{{ forloop.counter }}" 
            data-question="{{ forloop.counter }}"> {% endcomment %}
          <div class="question-container {% if forloop.first %}block{% else %}hidden{% endif %}" 
            id="question-{{ forloop.counter }}"
            data-question="{{ forloop.counter }}"
            data-question-id="{% if question|is_question %}{{ question.id }}{% elif question|is_essay_question %}{{ question.id }}{% elif question|is_numeric_question %}{{ question.id }}{% endif %}">
            
            <div class="mb-3 p-3 md:p-4 border border-gray-200 rounded-lg transition-all duration-300 hover:shadow-lg">
              <div class="flex flex-col md:flex-row justify-between items-start mb-2 gap-1">
                <h3 class="text-sm md:text-lg font-semibold text-gray-800">السؤال: {{ forloop.counter|arabic_ordinal }}</h3>
                <span class="bg-blue-100 text-blue-800 text-xs md:text-sm font-medium px-2 py-1 rounded-full">
                  درجة السؤال: 
                  {% if question|is_question %}
                    {{ question.points }}
                  {% elif question|is_essay_question %}
                    {{ question.marks }}
                  {% elif question|is_numeric_question %}
                    {{ question.marks }}
                  {% endif %}
                </span>
              </div>
              <!-- نص السؤال -->
              <p class="text-gray-700 text-xs md:text-base mb-2 md:mb-3">
                {% if question|is_question %}
                  {{ question.text }}
                {% elif question|is_essay_question %}
                  {{ question.question_text }}
                {% elif question|is_numeric_question %}
                  {{ question.question_text }}
                {% endif %}
              </p>

              {% if question|is_question %}
                <!-- إجابات الاسئلة صح و خطاء و متعدد الخيارات -->
                <div class="space-y-1 md:space-y-2">
                  {% for answer in question.answers.all %}
                  <div class="transition-all duration-200 hover:-translate-x-1">
                    <input
                      type="radio"
                      name="question_{{ question.id }}"
                      id="q{{ question.id }}_option{{ forloop.counter }}"
                      value="{{ answer.id }}"
                      class="hidden peer"
                      required
                    />
                    <label
                      for="q{{ question.id }}_option{{ forloop.counter }}"
                      class="block w-full p-2 md:p-3 border border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-gray-50 text-xs md:text-base text-gray-800"
                    >
                      <span class="font-medium">{{ answer.answer_text }}</span>
                    </label>
                  </div>
                  {% endfor %}
                </div>
              {% elif question|is_essay_question %}
                <!-- إجابات الاسئلة المقالية -->
                <div class="essay-question mt-3">
                  <textarea 
                      name="essay_answer_{{ question.id }}"
                      id="essay_{{ question.id }}"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800"
                      rows="5"
                      placeholder="أكتب إجابتك هنا..."
                      required
                  ></textarea>
                  <div class="mt-2 text-xs text-gray-500">
                      <p>ملاحظة: يمكنك كتابة إجابتك في المساحة أعلاه. تأكد من مراجعة إجابتك قبل التسليم.</p>
                  </div>
                </div>
              {% elif question|is_numeric_question %}
                <!-- إجابات الاسئلة العددية -->
                <div class="numeric-question mt-3">
                  <input 
                    type="number"
                    name="numeric_answer_{{ question.id }}"
                    id="numeric_{{ question.id }}"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800 "
                    placeholder="أدخل الإجابة الرقمية هنا"
                    step="any"
                    required
                  >
                  <div class="mt-2 text-xs text-gray-500">
                      <p>ملاحظة: أدخل الرقم فقط دون أي رموز أو أحرف أخرى.</p>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
          
          <!-- الأزرار -->
          <div class="flex justify-between mt-3 md:mt-4 gap-1">
            <button
              type="button"
              id="prev-btn"
              class="px-2 py-1 md:px-4 md:py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-xs md:text-base"
              disabled
            >
              السابق
            </button>
            <button
              type="button"
              id="next-btn"
              class="px-2 py-1 md:px-4 md:py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-all text-xs md:text-base"
            >
              التالي
            </button>

            
            <button 
              type="submit"
              id="submit-btn" 
              name="finsh_submet_exam_butt"
              class="px-2 py-1 md:px-4 md:py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-all hidden text-xs md:text-base"
            >
              إنهاء الامتحان
            </button>

            {% comment %} <button {% endcomment %}
              {% comment %} type="submit"
              id="submit-btn"
              name="finsh_submet_exam_butt"
              class="px-2 py-1 md:px-4 md:py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-all hidden text-xs md:text-base"
            >
              إنهاء الامتحان
            </button> {% endcomment %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- قائمة الأسئلة الجانبية - النسخة النهائية -->
  <div class="lg:w-48 xl:w-56 h-full">
    <div class="sticky top-0 h-full">
      <div class="bg-gradient-to-br from-red-50 to-red-100 p-2 rounded-lg border border-red-200 shadow-sm h-full flex flex-col"> <!-- أضفنا flex flex-col و h-full -->
        <h3 class="text-sm md:text-base font-semibold mb-2 text-center text-red-800">
          قائمة الأسئلة
        </h3>
        <div class="flex-1 overflow-y-auto pr-1 custom-scroll">
          {% for question in exam_question_all_qution %}
          <div class="relative flex items-center gap-2 p-1 hover:bg-red-100 rounded transition-all cursor-pointer"
            onclick="goToQuestion({{ forloop.counter }})">
            
            <!-- شريط الإنجاز المتحرك -->
            <div class="absolute inset-y-0 right-0 w-0 bg-gradient-to-r from-green-300 to-green-500 transition-all duration-2000 ease-out"
              id="progress-{{ forloop.counter }}"></div>
            
            <!-- مربع الرقم - بنفس التنسيق الأصلي -->
            <div class="relative z-10 w-6 h-6 md:w-8 md:h-8 flex-shrink-0 flex items-center justify-center rounded-md 
              cursor-pointer transition-all duration-200 text-xs md:text-sm
              {% if forloop.first %}border-2 border-blue-500 bg-white text-blue-500
              {% else %}bg-red-500 text-white{% endif %}"
              data-question="{{ forloop.counter }}"
              id="dot-{{ forloop.counter }}">
              {{ forloop.counter }}
            </div>
            
            <!-- نص السؤال في سطر واحد -->
            <div class="relative z-10 flex-1 min-w-0 overflow-hidden">
              <p class="text-xs md:text-sm text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis" 
                title="{% if question|is_question %}{{ question.text }}{% elif question|is_essay_question %}{{ question.question_text }}{% elif question|is_numeric_question %}{{ question.question_text }}{% endif %}">
                {% if question|is_question %}
                  {{ question.text }}
                {% elif question|is_essay_question %}
                  {{ question.question_text }}
                {% elif question|is_numeric_question %}
                  {{ question.question_text }}
                {% endif %}
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // تحديث الشريط والمربع عند الإجابة
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
          radio.addEventListener('change', function() {
              const questionId = this.name.split('_')[1];
              const progressBar = document.getElementById(`progress-${questionId}`);
              const questionDot = document.getElementById(`dot-${questionId}`);
              
              // تحريك الشريط بسلاسة
              progressBar.style.width = '100%';
              progressBar.style.transition = 'width 0.7s cubic-bezier(0.65, 0, 0.35, 1)';
              
              // تغيير لون المربع إلى الأخضر عند الإجابة
              questionDot.classList.remove('bg-red-500', 'border-blue-500', 'bg-white', 'text-blue-500');
              questionDot.classList.add('bg-green-500');
          });
      });
      
      // وظيفة الانتقال بين الأسئلة (محدثة)
      window.goToQuestion = function(questionNum) {
          // إخفاء كل الأسئلة
          document.querySelectorAll('.question-container').forEach(q => {
              q.classList.add('hidden');
              q.classList.remove('block');
          });
          
          // إظهار السؤال المطلوب
          document.getElementById(`question-${questionNum}`).classList.remove('hidden');
          document.getElementById(`question-${questionNum}`).classList.add('block');
          
          // تحديث حالة النقاط في القائمة الجانبية
          document.querySelectorAll('[data-question]').forEach(dot => {
              const dotQuestionNum = parseInt(dot.dataset.question);
              const isAnswered = document.querySelector(`input[name="question_${dotQuestionNum}"]:checked`) !== null;
              
              if (dotQuestionNum === questionNum) {
                  dot.classList.remove('bg-red-500', 'bg-green-500');
                  dot.classList.add('border-2', 'border-blue-500', 'bg-white', 'text-blue-500');
              } else if (isAnswered) {
                  dot.classList.remove('border-2', 'border-blue-500', 'bg-white', 'text-blue-500', 'bg-red-500');
                  dot.classList.add('bg-green-500', 'text-white');
              } else {
                  dot.classList.remove('border-2', 'border-blue-500', 'bg-white', 'text-blue-500', 'bg-green-500');
                  dot.classList.add('bg-red-500', 'text-white');
              }
          });
          
          currentQuestion = questionNum;
          document.getElementById('prev-btn').disabled = (currentQuestion === 1);

          if (currentQuestion === totalQuestions) {
              document.getElementById('next-btn').classList.add('hidden');
              document.getElementById('submit-btn').classList.remove('hidden');
          } else {
              document.getElementById('next-btn').classList.remove('hidden');
              document.getElementById('submit-btn').classList.add('hidden');
          }
          
          // التمرير لأعلى الصفحة
          window.scrollTo({top: 0, behavior: 'smooth'});
      };
    });
  </script>  

  <style>

      /* تنسيقات إضافية للخطوط */
    .font-tajawal {
        font-family: 'Tajawal', sans-serif;
    }

    /* لون النص العام */
    body {
        color: #1f2937; /* رمادي داكن */
    }

    /* لون نص الإجابات */
    textarea, input[type="number"], input[type="text"] {
        color: #1f2937 !important;
    }

    /* لون النص عند التحديد */
    .peer-checked:border-blue-500 .font-medium {
        color: #1f2937;
    }

    /* لون النص في حالة hover */
    .hover:bg-gray-50 .font-medium {
        color: #1f2937;
    }

    /* لون النص في حالة التركيز */
    textarea:focus, input:focus {
        color: #1f2937;
    }




      /* شريط التمرير المخصص */
      .custom-scroll::-webkit-scrollbar {
          width: 4px;
      }
      .custom-scroll::-webkit-scrollbar-track {
          background: #fecaca;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
          background: #ef4444;
          border-radius: 4px;
      }
      
      /* تأثيرات الشريط المتحرك */
      [id^="progress-"] {
          opacity: 0.6;
          z-index: 1;
      }
      
      /* تأثيرات الانتقال */
      .transition-all {
          transition-property: all;
          transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
          transition-duration: 200ms;
      }
      


    
  </style>

</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
  .font-tajawal {
      font-family: 'Tajawal', sans-serif;
  }
</style>
{% endblock content %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // إعداد العداد
    let timeLeft = 119 * 60;
    const timerElement = document.getElementById('time');
    const progressBar = document.getElementById('progress-bar');
    const totalQuestions = {{ exam_question_all_qution|length }};
    let currentQuestion = 1;
    
    function updateTimer() {
        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = timeLeft % 60;

        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            document.getElementById('exam-form').submit();
        } else {
            timeLeft--;
        }

        const progressPercent = (currentQuestion / totalQuestions) * 100;
        progressBar.style.width = `${progressPercent}%`;
    }

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    // التحكم بين الأسئلة
    window.goToQuestion = function(questionNum) {
        // إخفاء كل الأسئلة
        document.querySelectorAll('.question-container').forEach(q => {
            q.classList.add('hidden');
            q.classList.remove('block');
        });
        
        // إظهار السؤال المطلوب
        document.getElementById(`question-${questionNum}`).classList.remove('hidden');
        document.getElementById(`question-${questionNum}`).classList.add('block');
        
        // تحديث حالة النقاط في القائمة الجانبية
        document.querySelectorAll('[data-question]').forEach(dot => {
            const dotQuestionNum = parseInt(dot.dataset.question);
            const isAnswered = document.querySelector(`input[name="question_${dotQuestionNum}"]:checked`) !== null;
            
            if (dotQuestionNum === questionNum) {
                dot.classList.remove('bg-red-500', 'bg-green-500');
                dot.classList.add( 'bg-white', 'text-blue-500');
            } else if (isAnswered) {
                dot.classList.remove('border-2', 'border-blue-500', 'bg-white', 'text-blue-500', 'bg-red-500');
                dot.classList.add('bg-green-500', 'text-white');
            } else {
                dot.classList.remove('border-2', 'border-blue-500', 'bg-white', 'text-blue-500', 'bg-green-500');
                dot.classList.add('bg-red-500', 'text-white');
            }
        });
        
        currentQuestion = questionNum;
        document.getElementById('prev-btn').disabled = (currentQuestion === 1);

        if (currentQuestion === totalQuestions) {
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('submit-btn').classList.remove('hidden');
        } else {
            document.getElementById('next-btn').classList.remove('hidden');
            document.getElementById('submit-btn').classList.add('hidden');
        }
        
        // التمرير لأعلى الصفحة
        window.scrollTo({top: 0, behavior: 'smooth'});
    };

    document.getElementById('next-btn').addEventListener('click', function() {
        if (currentQuestion < totalQuestions) {
            goToQuestion(currentQuestion + 1);
        }
    });

    document.getElementById('prev-btn').addEventListener('click', function() {
        if (currentQuestion > 1) {
            goToQuestion(currentQuestion - 1);
        }
    });

    document.getElementById('exam-form').addEventListener('submit', function(e) {
        if (timeLeft > 0) {
            const confirmation = confirm('هل أنت متأكد أنك تريد إنهاء الامتحان؟');
            if (!confirmation) {
                e.preventDefault();
            }
        }
    });
    
    // تحديث حالة النقاط عند اختيار إجابة
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionNum = this.name.split('_')[1];
            const dot = document.querySelector(`[data-question="${questionNum}"]`);
            if (dot && !dot.classList.contains('border-blue-500')) {
                dot.classList.remove('bg-red-500');
            }
        });
    });




    {% comment %} ========= الاجابات تتبع ==========
    function saveAnswer(questionId, answerData, questionType) {
        const form = document.getElementById('exam-form');
        const formData = new FormData(form);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // إضافة البيانات الإضافية
        formData.append('question_id', questionId);
        formData.append('question_type', questionType);
        
        console.log("Sending data:", {
            questionId,
            answerData,
            questionType
        });

        fetch('/student_app/student_exam/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Response:", data);
            if (data.status === 'success') {
                // تحديث الواجهة
                const questionNumber = document.querySelector(`#question-${questionId}`).dataset.question;
                const dot = document.getElementById(`dot-${questionNumber}`);
                if (dot) {
                    dot.classList.remove('bg-red-500');
                    dot.classList.add('bg-green-500');
                    
                    const progressBar = document.getElementById(`progress-${questionNumber}`);
                    if (progressBar) {
                        progressBar.style.width = '100%';
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // الأسئلة الموضوعية
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionId = this.name.split('_')[1];
            const answerId = this.value;
            saveAnswer(questionId, {answer_id: answerId}, 'objective');
        });
    });

    // الأسئلة العددية
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('change', function() {
            const questionId = this.id.split('_')[1];
            const answerValue = this.value;
            saveAnswer(questionId, {answer_value: answerValue}, 'numeric');
        });
    });

    // الأسئلة المقالية
    let essayTimeout;
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
            clearTimeout(essayTimeout);
            essayTimeout = setTimeout(() => {
                const questionId = this.id.split('_')[1];
                const answerText = this.value;
                saveAnswer(questionId, {answer_text: answerText}, 'essay');
            }, 1000);
        });
    }); {% endcomment %}




    function saveAnswer(questionType) {
        const currentQuestionElement = document.querySelector(`.question-container:not(.hidden)`);
        const questionRealId = currentQuestionElement.getAttribute('data-question-id'); // الحصول على ID الحقيقي
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        let formData = new FormData();
        
        if (questionType === 'objective') {
            const selectedOption = currentQuestionElement.querySelector('input[type="radio"]:checked');
            if (!selectedOption) return;
            
            formData.append('question_id', questionRealId); // استخدام ID الحقيقي
            formData.append('answer_id', selectedOption.value);
            formData.append('question_type', 'objective');
        } 
        else if (questionType === 'essay') {
            const answerText = currentQuestionElement.querySelector('textarea').value;
            if (!answerText.trim()) return;
            
            formData.append('question_id', questionRealId); // استخدام ID الحقيقي
            formData.append('answer_text', answerText);
            formData.append('question_type', 'essay');
        }
        else if (questionType === 'numeric') {
            const numericInput = currentQuestionElement.querySelector('input[type="number"]');
            const answerValue = numericInput.value;
            
            if (!answerValue || isNaN(answerValue)) return;
            
            formData.append('question_id', questionRealId); // استخدام ID الحقيقي
            formData.append('answer_value', answerValue);
            formData.append('question_type', 'numeric');
        }

        formData.append('csrfmiddlewaretoken', csrfToken);

        // Debugging
        console.log('إرسال بيانات السؤال:', {
            questionId: questionRealId,
            questionType: questionType
        });

        fetch('/student_app/student_exam/', {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('تم حفظ إجابة السؤال ID:', questionRealId);
                updateQuestionStatus(currentQuestionElement.dataset.question);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function updateQuestionStatus(questionNumber) {
        const questionDot = document.getElementById(`dot-${questionNumber}`);
        if (questionDot) {
            questionDot.classList.remove('bg-red-500');
            questionDot.classList.add('bg-green-500');
        }
    }

    

        // للأسئلة الموضوعية
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => saveAnswer('objective'));
    });

    // للأسئلة المقالية
    document.querySelectorAll('textarea').forEach(textarea => {
        let timeout;
        textarea.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => saveAnswer('essay'), 1000);
        });
    });

    // للأسئلة العددية
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('change', () => saveAnswer('numeric'));
    });




  });
</script>
{% endblock extra_js %}